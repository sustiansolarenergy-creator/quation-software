<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustain Solar ERP - Pro GST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #eab308; }
        body { background: #f4f7f6; font-family: 'Inter', sans-serif; min-height: 100vh; margin: 0; }
        .glass { background: white; border-radius: 15px; border: 1px solid rgba(0,0,0,0.1); }
        .sidebar { background: #0f172a; min-height: 100vh; color: white; transition: 0.3s; z-index: 1050; }
        
        @media (max-width: 768px) { 
            .sidebar { position: fixed; left: -100%; width: 280px; box-shadow: 10px 0 20px rgba(0,0,0,0.2); }
            .sidebar.active { left: 0; }
            .main-content { padding-top: 60px !important; }
        }
        .mobile-header { display: none; background: #0f172a; color: white; padding: 10px 20px; position: fixed; top: 0; width: 100%; z-index: 1040; }
        @media (max-width: 768px) { .mobile-header { display: flex; justify-content: space-between; align-items: center; } }
        
        .nav-link { color: #cbd5e1; padding: 12px; margin: 4px 0; border-radius: 10px; text-decoration: none; display: flex; align-items: center; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: black !important; font-weight: bold; }
        .hidden { display: none !important; }
        
        .invoice-box { width: 100%; max-width: 210mm; padding: 10mm; margin: auto; background: white; color: #333; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        #logoDisp { max-height: 55px; width: auto; object-fit: contain; margin-bottom: 10px; }
        
        .label-input { border: none; background: transparent; font-weight: inherit; color: inherit; width: 100%; outline: none; }
        .label-input:focus { border-bottom: 1px solid var(--accent); }
        .table-dark .label-input { color: white; }

        .desc-cell, #invFullDesc, #invCustAddr { max-width: 350px; word-wrap: break-word !important; overflow-wrap: break-word !important; white-space: pre-wrap !important; line-height: 1.5; }
        
        .pagination-controls { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .search-box { max-width: 250px; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .invoice-box { box-shadow: none; margin: 0; width: 100%; padding: 0mm; border: none; }
            .card-section { break-inside: avoid; margin-bottom: 15px; }
        }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="mobile-header no-print">
    <h5 class="m-0 text-warning fw-bold">SUSTAIN SOLAR</h5>
    <button class="btn btn-dark border-secondary" onclick="toggleSidebar()"><i class="bi bi-list fs-3"></i></button>
</div>

<div id="loginSection" class="container d-flex justify-content-center align-items-center vh-100 no-print">
    <div class="glass p-4 p-md-5 text-center shadow-lg" style="width: 100%; max-width: 400px;">
        <h2 class="fw-bold text-dark mb-4">SUSTAIN SOLAR</h2>
        <form id="loginForm">
            <input type="text" id="userInput" class="form-control mb-3" placeholder="Username" value="admin">
            <input type="password" id="passInput" class="form-control mb-4" placeholder="Password" value="1234">
            <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">LOG IN</button>
        </form>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar" class="col-md-3 col-lg-2 sidebar p-3 no-print">
                <h4 class="text-warning fw-bold mb-4">SUSTAIN</h4>
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="showPage('listView')"><i class="bi bi-files me-2"></i> Quotations</a>
                    <a class="nav-link" onclick="startNewEntry()"><i class="bi bi-plus-square me-2"></i> New Entry</a>
                    <div class="mt-4 p-2 border border-secondary rounded small">
                        <label class="fw-bold text-warning small mb-1">Company Logo</label>
                        <input type="file" class="form-control form-control-sm bg-dark text-white border-0" onchange="handleLogo(event)">
                    </div>
                    <a class="nav-link text-danger mt-5" onclick="location.reload()"><i class="bi bi-box-arrow-left me-2"></i> Logout</a>
                </nav>
            </div>

            <div class="col-md-9 col-lg-10 p-3 p-md-4 main-content">
                
                <div id="listView" class="glass p-3 p-md-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                        <h4 class="fw-bold m-0">Project Tracker</h4>
                        <div class="d-flex gap-2">
                            <input type="text" id="searchInput" class="form-control form-control-sm search-box" placeholder="Search customer or ref..." oninput="handleSearch()">
                            <button class="btn btn-sm btn-primary" onclick="loadFromCloud()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                        </div>
                    </div>
                    <div id="syncLoader" class="hidden alert alert-info py-2 small"><div class="loader me-2"></div> Syncing with Cloud...</div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle bg-white rounded">
                            <thead class="table-light"><tr><th>Ref No</th><th>Customer</th><th>Status</th><th>Net Price</th><th>Action</th></tr></thead>
                            <tbody id="quoteTable"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls no-print">
                        <button id="prevBtn" class="btn btn-sm btn-outline-dark" onclick="changePage(-1)">Previous</button>
                        <span id="pageInfo" class="align-self-center small fw-bold"></span>
                        <button id="nextBtn" class="btn btn-sm btn-outline-dark" onclick="changePage(1)">Next</button>
                    </div>
                </div>

                <div id="formView" class="hidden glass p-3 p-md-4 shadow-sm">
                    <h4 id="formTitle" class="fw-bold mb-4 text-primary">Comprehensive Project Entry</h4>
                    <form id="proposalForm">
                        <div class="row g-3">
                            <div class="col-md-3"><label class="small fw-bold">Ref No</label><input type="text" id="manualRef" class="form-control" required></div>
                            <div class="col-md-3"><label class="small fw-bold">Customer Name</label><input type="text" id="cName" class="form-control" required></div>
                            <div class="col-md-3"><label class="small fw-bold">Status</label>
                                <select id="pStatus" class="form-select">
                                    <option>Quotation</option><option>In Progress</option><option>Completed</option>
                                </select>
                            </div>
                            <div class="col-md-3"><label class="small fw-bold">Phone</label><input type="text" id="cPhone" class="form-control" required></div>
                            <div class="col-12"><label class="small fw-bold">Address</label><input type="text" id="cAddr" class="form-control"></div>
                            
                            <hr class="my-4">
                            
                            <div class="col-md-4"><label class="small fw-bold">Solar Panel</label><input type="text" id="pBrand" class="form-control" value="Waaree 540Wp Mono PERC"></div>
                            <div class="col-md-4"><label class="small fw-bold">Inverter</label><input type="text" id="invBrand" class="form-control" value="Solis / Growatt"></div>
                            <div class="col-md-4"><label class="small fw-bold">Structure</label><input type="text" id="structType" class="form-control" value="GI Hot Dipped High Rise"></div>
                            <div class="col-md-3"><label class="small fw-bold">Capacity (kW)</label><input type="number" id="sSize" class="form-control" value="3.3" step="0.1"></div>
                            <div class="col-12"><label class="small fw-bold">Work Description</label><textarea id="pDesc" class="form-control" rows="2"></textarea></div>
                            
                            <div class="col-md-3"><label class="small fw-bold">Base Price (₹)</label><input type="number" id="fTotal" class="form-control" value="200000" oninput="liveCalc()"></div>
                            <div class="col-md-3"><label class="small fw-bold">Installation (₹)</label><input type="number" id="fInstall" class="form-control" value="0" oninput="liveCalc()"></div>
                            <div class="col-md-3"><label class="small fw-bold">CGST (%)</label><input type="number" id="fCGST" class="form-control" value="2.5" oninput="liveCalc()"></div>
                            <div class="col-md-3"><label class="small fw-bold">SGST (%)</label><input type="number" id="fSGST" class="form-control" value="2.5" oninput="liveCalc()"></div>
                            <div class="col-md-4"><label class="small fw-bold text-success">Subsidy (₹)</label><input type="number" id="fSub" class="form-control" value="78000" oninput="liveCalc()"></div>
                            
                            <div class="col-md-8">
                                <div class="p-3 bg-light rounded border text-end">
                                    <span class="text-muted small">Estimated Net Payable:</span>
                                    <h3 class="fw-bold m-0" id="liveNet">₹0</h3>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" id="saveBtn" class="btn btn-success w-100 fw-bold py-2 shadow">SAVE TO CLOUD</button>
                                <button type="button" class="btn btn-light w-100 mt-2" onclick="showPage('listView')">CANCEL</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="invoiceView" class="hidden">
                    <div class="no-print d-flex gap-2 justify-content-end mb-3 flex-wrap">
                        <button class="btn btn-secondary btn-sm" onclick="showPage('listView')">Back</button>
                        <button class="btn btn-success btn-sm" onclick="sendWhatsApp()">WhatsApp</button>
                        <button class="btn btn-danger btn-sm" onclick="downloadPDF()">PDF</button>
                        <button class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
                    </div>
                    <div class="invoice-box" id="invoiceContent">
                        <div class="row mb-3 border-bottom pb-2">
                            <div class="col-7">
                                <img id="logoDisp" src="" class="hidden" alt="Logo">
                                <h4 class="fw-bold text-primary mb-0">SUSTAIN SOLAR POWER</h4>
                                <p class="small mb-0">GSTIN: 33AAAAA0000A1Z5 | +91 81225 63474</p>
                            </div>
                            <div class="col-5 text-end small">
                                <h5 class="fw-bold text-secondary">PROJECT PROPOSAL</h5>
                                <b>Ref:</b> <span id="invRef"></span><br><b>Date:</b> <span id="invDate"></span>
                            </div>
                        </div>
                        <div class="row mb-3 small">
                            <div class="col-6">
                                <h6 class="fw-bold border-bottom d-inline-block">BILL TO:</h6>
                                <div id="invCustName" class="fw-bold"></div>
                                <div id="invCustAddr" class="text-muted"></div>
                            </div>
                            <div class="col-6 text-end">
                                <h6 class="fw-bold border-bottom d-inline-block">STATUS:</h6>
                                <div id="invStatus" class="fw-bold text-warning"></div>
                            </div>
                        </div>

                        <table class="table table-bordered small mb-3">
                            <thead class="table-dark">
                                <tr><th>Description</th><th class="text-end" style="width: 140px;">Amount (₹)</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="desc-cell">
                                        <input type="text" id="invHeader" class="label-input fw-bold">
                                        <div id="invFullDesc" class="text-muted small"></div>
                                    </td>
                                    <td class="text-end fw-bold" id="invBaseVal"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" class="label-input" value="Installation & Commissioning"></td>
                                    <td class="text-end fw-bold" id="invInstallVal"></td>
                                </tr>
                                <tr>
                                    <td class="text-end"><div class="d-flex justify-content-end align-items-center"><input type="text" class="label-input text-end" value="CGST" style="width: 60px;"><span class="ms-1">(%)</span></div></td>
                                    <td class="text-end"><input type="number" id="rate1" class="label-input text-end fw-bold" oninput="calculateGST()"></td>
                                </tr>
                                <tr>
                                    <td class="text-end"><div class="d-flex justify-content-end align-items-center"><input type="text" class="label-input text-end" value="SGST" style="width: 60px;"><span class="ms-1">(%)</span></div></td>
                                    <td class="text-end"><input type="number" id="rate2" class="label-input text-end fw-bold" oninput="calculateGST()"></td>
                                </tr>
                                <tr class="table-light fw-bold"><td><input type="text" class="label-input fw-bold" value="GROSS TOTAL"></td><td class="text-end" id="invGross"></td></tr>
                                <tr class="text-success fw-bold"><td><input type="text" class="label-input fw-bold text-success" value="GOVT. SUBSIDY"></td><td class="text-end" id="invSub"></td></tr>
                                <tr class="table-secondary border-dark fw-bold"><td><input type="text" class="label-input fw-bold" value="TOTAL NET PAYABLE"></td><td class="text-end" id="invNet"></td></tr>
                            </tbody>
                        </table>

                        <div class="row g-2 mb-3 card-section">
                            <div class="col-6"><div class="annex-box small"><h6 class="fw-bold border-bottom text-primary">SPECS</h6><b>Panels:</b> <span id="specPanel"></span><br><b>Inv:</b> <span id="specInv"></span><br><b>Struct:</b> <span id="specStruct"></span></div></div>
                            <div class="col-6"><div class="annex-box small"><h6 class="fw-bold border-bottom text-success">SAVINGS</h6><b>Units/Mon:</b> <span id="saveUnits"></span><br><b>Mon Save:</b> ₹<span id="saveMonth"></span><br><b>25Y Save:</b> <span id="saveLife"></span></div></div>
                        </div>
                        <div class="p-2 border rounded small card-section mb-3">
                            <h6 class="fw-bold border-bottom">PAYMENT SCHEDULE</h6>
                            <div class="d-flex justify-content-between"><span>Advance (60%)</span><b id="p60"></b></div>
                            <div class="d-flex justify-content-between"><span>Delivery (30%)</span><b id="p30"></b></div>
                            <div class="d-flex justify-content-between"><span>Commissioning (10%)</span><b id="p10"></b></div>
                        </div>
                        <div class="row mt-4 card-section small">
                            <div class="col-7 border-end"><b>HDFC BANK</b> | Sustain Solar Power<br>A/c: 06942320000402 | IFSC: HDFC0000694</div>
                            <div class="col-5 text-center"><p class="fw-bold mb-4">For SUSTAIN SOLAR POWER</p><p class="mb-0 border-top">Authorized Signatory</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzIdnrjeYGSt3nUIeaMKMpx8m5vLFcCyy2qF8fpNLton7kwVB201dhSXmDgfdfuUHW9Bw/exec";
    
    let quotes = [], filteredQuotes = [];
    let currentPage = 1, rowsPerPage = 10, currentEditRow = null;
    let currentBase = 0, currentInstall = 0, currentSub = 0, currentQuoteData = null;

    window.onload = () => {
        const logo = localStorage.getItem('sustain_logo');
        if(logo) { document.getElementById('logoDisp').src = logo; document.getElementById('logoDisp').classList.remove('hidden'); }
        loadFromCloud();
    };

    function handleLogo(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            localStorage.setItem('sustain_logo', ev.target.result);
            document.getElementById('logoDisp').src = ev.target.result;
            document.getElementById('logoDisp').classList.remove('hidden');
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    document.getElementById('loginForm').onsubmit = (e) => {
        e.preventDefault();
        if(document.getElementById('userInput').value === 'admin' && document.getElementById('passInput').value === '1234') {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        } else alert('Wrong Credentials!');
    };

    function showPage(id) {
        ['listView', 'formView', 'invoiceView'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    async function loadFromCloud() {
        document.getElementById('syncLoader').classList.remove('hidden');
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            quotes = data.reverse(); 
            filteredQuotes = [...quotes];
            renderTable();
        } catch (e) { alert("Load Failed!"); }
        document.getElementById('syncLoader').classList.add('hidden');
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        filteredQuotes = quotes.filter(q => 
            (q.Customer && q.Customer.toLowerCase().includes(term)) || 
            (q.Ref && q.Ref.toString().toLowerCase().includes(term))
        );
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tb = document.getElementById('quoteTable'); tb.innerHTML = "";
        const start = (currentPage - 1) * rowsPerPage;
        const paginated = filteredQuotes.slice(start, start + rowsPerPage);

        paginated.forEach((q) => {
            const final = (parseFloat(q.BasePrice || 0) + parseFloat(q.Installation || 0)) - parseFloat(q.Subsidy || 0);
            const globalIdx = quotes.indexOf(q);
            tb.innerHTML += `<tr>
                <td>${q.Ref || ''}</td><td><b>${q.Customer || ''}</b></td>
                <td><span class="badge bg-secondary">${q.Status || ''}</span></td>
                <td>₹${final.toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${globalIdx})"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-sm btn-outline-dark" onclick="editQuote(${globalIdx})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFromCloud(${q.rowNum})"><i class="bi bi-trash"></i></button>
                </td></tr>`;
        });
        updatePagination();
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredQuotes.length / rowsPerPage);
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages || 1}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    function changePage(dir) { currentPage += dir; renderTable(); }

    function startNewEntry() {
        currentEditRow = null;
        document.getElementById('proposalForm').reset();
        document.getElementById('formTitle').innerText = "New Project Entry";
        document.getElementById('saveBtn').innerText = "SAVE TO CLOUD";
        liveCalc();
        showPage('formView');
    }

    function editQuote(idx) {
        const q = quotes[idx];
        currentEditRow = q.rowNum;
        document.getElementById('manualRef').value = q.Ref || '';
        document.getElementById('cName').value = q.Customer || '';
        document.getElementById('pStatus').value = q.Status || 'Quotation';
        document.getElementById('cPhone').value = q.Phone || '';
        document.getElementById('cAddr').value = q.Address || '';
        document.getElementById('pBrand').value = q.SolarPanel || '';
        document.getElementById('invBrand').value = q.Inverter || '';
        document.getElementById('structType').value = q.Structure || '';
        document.getElementById('sSize').value = q.Capacity || '';
        document.getElementById('fTotal').value = q.BasePrice || '';
        document.getElementById('fInstall').value = q.Installation || '0';
        document.getElementById('fSub').value = q.Subsidy || '0';
        document.getElementById('pDesc').value = q.Description || '';
        document.getElementById('formTitle').innerText = "Edit Project Info";
        document.getElementById('saveBtn').innerText = "UPDATE IN CLOUD";
        liveCalc();
        showPage('formView');
    }

    function liveCalc() {
        const b = parseFloat(document.getElementById('fTotal').value) || 0;
        const i = parseFloat(document.getElementById('fInstall').value) || 0;
        const c = parseFloat(document.getElementById('fCGST').value) || 0;
        const s = parseFloat(document.getElementById('fSGST').value) || 0;
        const sub = parseFloat(document.getElementById('fSub').value) || 0;
        
        const taxable = b + i;
        const taxAmt = (taxable * (c + s)) / 100;
        const net = (taxable + taxAmt) - sub;
        document.getElementById('liveNet').innerText = "₹" + net.toLocaleString();
    }

    document.getElementById('proposalForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn'); btn.disabled = true;
        const obj = {
            action: currentEditRow ? "edit" : "add",
            rowNum: currentEditRow,
            ref: document.getElementById('manualRef').value,
            name: document.getElementById('cName').value,
            status: document.getElementById('pStatus').value,
            phone: document.getElementById('cPhone').value,
            addr: document.getElementById('cAddr').value,
            panel: document.getElementById('pBrand').value,
            inv: document.getElementById('invBrand').value,
            struct: document.getElementById('structType').value,
            size: document.getElementById('sSize').value,
            total: document.getElementById('fTotal').value,
            install: document.getElementById('fInstall').value,
            sub: document.getElementById('fSub').value,
            desc: document.getElementById('pDesc').value,
            date: new Date().toLocaleDateString()
        };
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(obj) });
        alert("Success!"); loadFromCloud(); showPage('listView'); btn.disabled = false;
    };

    async function deleteFromCloud(rowNum) {
        if(!confirm("Delete?")) return;
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete", rowNum: rowNum }) });
        loadFromCloud();
    }

    function calculateGST() {
        const r1 = parseFloat(document.getElementById('rate1').value) || 0;
        const r2 = parseFloat(document.getElementById('rate2').value) || 0;
        const taxable = currentBase + currentInstall;
        const tax = (taxable * (r1 + r2)) / 100;
        const gross = taxable + tax;
        const net = gross - currentSub;

        document.getElementById('invBaseVal').innerText = "₹" + currentBase.toLocaleString();
        document.getElementById('invInstallVal').innerText = "₹" + currentInstall.toLocaleString();
        document.getElementById('invGross').innerText = "₹" + gross.toLocaleString();
        document.getElementById('invNet').innerText = "₹" + net.toLocaleString();
        document.getElementById('p60').innerText = "₹" + (gross * 0.6).toLocaleString();
        document.getElementById('p30').innerText = "₹" + (gross * 0.3).toLocaleString();
        document.getElementById('p10').innerText = "₹" + (gross * 0.1).toLocaleString();
    }

    function viewInvoice(idx) {
        const q = quotes[idx]; currentQuoteData = q;
        currentBase = parseFloat(q.BasePrice || 0); 
        currentInstall = parseFloat(q.Installation || 0); 
        currentSub = parseFloat(q.Subsidy || 0);

        document.getElementById('invRef').innerText = q.Ref;
        document.getElementById('invDate').innerText = q.Date;
        document.getElementById('invCustName').innerText = q.Customer;
        document.getElementById('invCustAddr').innerText = q.Address;
        document.getElementById('invStatus').innerText = q.Status;
        document.getElementById('invHeader').value = `${q.Capacity}kW Solar Power Plant`;
        document.getElementById('invFullDesc').innerText = q.Description || "";
        document.getElementById('invSub').innerText = "₹" + currentSub.toLocaleString();
        
        // Sync Invoice with Form GST Values
        document.getElementById('rate1').value = document.getElementById('fCGST').value;
        document.getElementById('rate2').value = document.getElementById('fSGST').value;

        document.getElementById('specPanel').innerText = q.SolarPanel;
        document.getElementById('specInv').innerText = q.Inverter;
        document.getElementById('specStruct').innerText = q.Structure;
        
        const units = (parseFloat(q.Capacity) || 0) * 4 * 30, monSave = units * 8;
        document.getElementById('saveUnits').innerText = units.toFixed(0) + " kWh";
        document.getElementById('saveMonth').innerText = monSave.toLocaleString();
        document.getElementById('saveLife').innerText = "₹" + (monSave * 12 * 25).toLocaleString();
        
        calculateGST(); 
        showPage('invoiceView');
    }

    function downloadPDF() { html2pdf().from(document.getElementById('invoiceContent')).save('Quotation.pdf'); }

    function sendWhatsApp() {
        const text = `Hello ${currentQuoteData.Customer},\n\nSolar Quotation Ref: ${currentQuoteData.Ref}\nTotal: ${document.getElementById('invNet').innerText}\nSustain Solar Power.`;
        window.open(`https://wa.me/${currentQuoteData.Phone}?text=${encodeURIComponent(text)}`, '_blank');
    }
</script>
</body>
</html>